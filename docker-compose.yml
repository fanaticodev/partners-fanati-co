version: '3.8'

# Partners Fanati.co MLM Platform - Docker Orchestration
# This file orchestrates both Infinite MLM (primary) and HybridMLM (legacy) applications
# with their respective databases, nginx reverse proxy, and Redis cache.
#
# Port Mappings:
#   - 8085: Infinite MLM (localhost only)
#   - 8086: Hybrid MLM (localhost only)
#   - 8088: Nginx Router (localhost only)
#   - 3308: Infinite MLM Database (localhost only)
#   - 3309: Hybrid MLM Database (localhost only)
#
# Usage:
#   docker-compose up -d              # Start all services
#   docker-compose ps                 # Check status
#   docker-compose logs -f [service]  # View logs
#   ./sandbox.sh up                   # Use sandbox environment

services:
  # ============================================
  # Infinite MLM Software (Primary)
  # ============================================
  # Modern MLM platform - awaiting software installation
  # Access: https://partners.fanati.co (production)
  #         https://sandbox.partners.fanati.co (sandbox)
  infinite-mlm:
    build: ./infinite-mlm
    container_name: infinite-mlm
    restart: unless-stopped
    ports:
      - "127.0.0.1:8085:80"  # Localhost access only for security
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
    volumes:
      - ./infinite-mlm/src:/var/www/html  # Source code mount
      - infinite-storage:/var/www/html/storage  # Persistent storage
      - infinite-cache:/var/www/html/bootstrap/cache  # Cache directory
    depends_on:
      - infinite-mlm-db
    networks:
      - partners-network  # Internal network for service communication
      - web-network      # External network for nginx proxy

  infinite-mlm-db:
    image: mariadb:10.11
    container_name: infinite-mlm-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${INFINITE_DB_ROOT_PASSWORD:-rootpass2024}
      - MYSQL_DATABASE=infinite_mlm
      - MYSQL_USER=${INFINITE_DB_USER:-infinite_user}
      - MYSQL_PASSWORD=${INFINITE_DB_PASSWORD:-infinitepass2024}
    volumes:
      - infinite-db-data:/var/lib/mysql
    ports:
      - "127.0.0.1:3308:3306"
    networks:
      - partners-network

  # ============================================
  # HybridMLM (Legacy)
  # ============================================
  hybrid-mlm:
    build: ./hybrid-mlm
    container_name: hybrid-mlm
    restart: unless-stopped
    ports:
      - "127.0.0.1:8086:80"
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
    volumes:
      - ./hybrid-mlm/public_html:/var/www/html
      - hybrid-storage:/var/www/html/storage
    depends_on:
      - hybrid-mlm-db
    networks:
      - partners-network
      - web-network

  hybrid-mlm-db:
    image: mariadb:10.11
    container_name: hybrid-mlm-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${HYBRID_DB_ROOT_PASSWORD:-rootpass2024}
      - MYSQL_DATABASE=hybrid_mlm
      - MYSQL_USER=${HYBRID_DB_USER:-hybrid_user}
      - MYSQL_PASSWORD=${HYBRID_DB_PASSWORD:-hybridpass2024}
    volumes:
      - hybrid-db-data:/var/lib/mysql
    ports:
      - "127.0.0.1:3309:3306"
    networks:
      - partners-network

  # ============================================
  # Nginx Reverse Proxy
  # ============================================
  # Routes traffic between Infinite MLM and Hybrid MLM
  # Path-based routing: / → Infinite MLM, /legacy → Hybrid MLM
  # Note: SSL termination happens at the main server nginx, not here
  nginx-router:
    image: nginx:alpine
    container_name: partners-nginx
    restart: unless-stopped
    ports:
      - "127.0.0.1:8088:80"  # Main server nginx proxies to this port
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro  # Main nginx config
      - ./nginx/conf.d:/etc/nginx/conf.d:ro          # Site-specific configs
    depends_on:
      - infinite-mlm
      - hybrid-mlm
    networks:
      - partners-network  # Connects to both MLM applications
      - web-network      # External network for main server access

  # ============================================
  # Redis Cache (Shared)
  # ============================================
  # Shared Redis instance for session storage and caching
  # Can be used by both MLM applications for performance
  redis:
    image: redis:7-alpine
    container_name: partners-redis
    restart: unless-stopped
    command: redis-server --appendonly yes  # Enable persistence
    volumes:
      - redis-data:/data  # Persistent data storage
    networks:
      - partners-network  # Internal network only, no external ports

# ============================================
# Docker Volumes
# ============================================
# Named volumes ensure data persistence across container restarts
# Data is stored in /var/lib/docker/volumes/ on the host
volumes:
  infinite-db-data:    # Infinite MLM database files
    driver: local
  infinite-storage:    # Infinite MLM application storage (uploads, logs)
    driver: local
  infinite-cache:      # Infinite MLM cache files
    driver: local
  hybrid-db-data:      # Hybrid MLM database files
    driver: local
  hybrid-storage:      # Hybrid MLM application storage
    driver: local
  redis-data:          # Redis persistence file
    driver: local

# ============================================
# Docker Networks
# ============================================
networks:
  partners-network:    # Internal network for inter-service communication
    driver: bridge     # Isolated from host network
  web-network:         # External network for main server nginx proxy
    external: true     # Must be created manually: docker network create web-network