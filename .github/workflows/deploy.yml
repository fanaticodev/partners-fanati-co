name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.FREMONT2_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.FREMONT2_HOST }} >> ~/.ssh/known_hosts

      - name: Pull Latest Code
        env:
          FREMONT2_HOST: ${{ secrets.FREMONT2_HOST }}
          FREMONT2_USER: ${{ secrets.FREMONT2_USER }}
        run: |
          echo "üöÄ Starting deployment of partners.fanati.co..."
          echo "üì• Pulling latest code from GitHub..."
          ssh $FREMONT2_USER@$FREMONT2_HOST "cd /home/sebastian/git-repos/partners-fanati-co && git pull origin main"

      - name: Copy to Production Directory
        env:
          FREMONT2_HOST: ${{ secrets.FREMONT2_HOST }}
          FREMONT2_USER: ${{ secrets.FREMONT2_USER }}
        run: |
          echo "üì¶ Syncing to production directory..."
          ssh $FREMONT2_USER@$FREMONT2_HOST "rsync -av --delete \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='vendor' \
            --exclude='node_modules' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            /home/sebastian/git-repos/partners-fanati-co/ \
            /home/sebastian/sites/partners.fanati.co/"

      - name: Rebuild and Restart Container
        env:
          FREMONT2_HOST: ${{ secrets.FREMONT2_HOST }}
          FREMONT2_USER: ${{ secrets.FREMONT2_USER }}
        run: |
          echo "üî® Rebuilding Docker image..."
          ssh $FREMONT2_USER@$FREMONT2_HOST "cd /home/sebastian/sites/partners.fanati.co && docker-compose build partners_app"

          echo "üõë Stopping and removing old container..."
          ssh $FREMONT2_USER@$FREMONT2_HOST "cd /home/sebastian/sites/partners.fanati.co && docker-compose stop partners_app && docker-compose rm -f partners_app || true"

          echo "üîÑ Starting new container..."
          ssh $FREMONT2_USER@$FREMONT2_HOST "cd /home/sebastian/sites/partners.fanati.co && docker-compose up -d partners_app"

          echo "‚è≥ Waiting for container to be ready..."
          sleep 15

      - name: Run Laravel Setup Commands
        env:
          FREMONT2_HOST: ${{ secrets.FREMONT2_HOST }}
          FREMONT2_USER: ${{ secrets.FREMONT2_USER }}
        run: |
          echo "üìù Running Laravel setup commands..."

          # Install/update composer dependencies (inside container)
          ssh $FREMONT2_USER@$FREMONT2_HOST "docker exec partners_app composer install --no-dev --optimize-autoloader"

          # Run database migrations
          ssh $FREMONT2_USER@$FREMONT2_HOST "docker exec partners_app php artisan migrate --force" || echo "‚ö†Ô∏è  Migrations failed (may be expected if DB not ready)"

          # Clear and cache configs
          ssh $FREMONT2_USER@$FREMONT2_HOST "docker exec partners_app php artisan config:cache"
          ssh $FREMONT2_USER@$FREMONT2_HOST "docker exec partners_app php artisan route:cache"
          ssh $FREMONT2_USER@$FREMONT2_HOST "docker exec partners_app php artisan view:cache"

      - name: Health Check
        env:
          FREMONT2_HOST: ${{ secrets.FREMONT2_HOST }}
          FREMONT2_USER: ${{ secrets.FREMONT2_USER }}
        run: |
          echo "üè• Running health check..."
          sleep 10

          # Check if container is running
          if ssh $FREMONT2_USER@$FREMONT2_HOST "docker ps | grep -q partners_app"; then
            echo "‚úÖ Container is running"
          else
            echo "‚ùå Container is not running"
            exit 1
          fi

          # Check if site responds (when it's set up with NGINX)
          # ssh $FREMONT2_USER@$FREMONT2_HOST "curl -f http://localhost:8080/health" || echo "‚ö†Ô∏è  Health endpoint not responding (may not be configured yet)"

          echo "‚úÖ Deployment completed successfully!"

      - name: Cleanup
        env:
          FREMONT2_HOST: ${{ secrets.FREMONT2_HOST }}
          FREMONT2_USER: ${{ secrets.FREMONT2_USER }}
        run: |
          echo "üßπ Cleaning up unused Docker resources..."
          ssh $FREMONT2_USER@$FREMONT2_HOST "docker system prune -f"